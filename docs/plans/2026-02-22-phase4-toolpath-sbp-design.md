# Phase 4: パス生成 + SBP出力 — 設計ドキュメント

> 日付: 2026-02-22
> Issue: #4
> 前提: Phase 3 完了済み（PR #9 マージ済み）

## スコープ

- ポストプロセッサ設定ノード（ノード5）— UI でSBP固有設定を入力
- ToolpathGen ノード（ノード6）— 多段パス生成 + タブ処理 + SBP 出力
- SBP ファイルダウンロード — ToolpathGen ノードにボタン設置
- マージノード（ノード4）はスキップ（Phase 6）
- プレビュー可視化は Phase 5

## アーキテクチャ: 分離型

パス計算と SBP コード生成を別エンドポイントに分ける。将来 pocket / drill 等の加工タイプ追加時に拡張しやすい。

### API エンドポイント

#### `POST /api/generate-toolpath`
- 入力: contours (ContourExtractResult) + machining_settings (MachiningSettings)
- 出力: toolpaths（パス座標 + Z深さ + タブ情報）
- 担当: `backend/nodes/toolpath_gen.py`

#### `POST /api/generate-sbp`
- 入力: toolpaths (ToolpathGenResult) + machining_settings (MachiningSettings) + post_processor (PostProcessorSettings)
- 出力: sbp_code (文字列) + filename
- 担当: `backend/sbp_writer.py`

## データモデル

### ToolpathGen 関連

```python
class ToolpathGenRequest(BaseModel):
    contour_result: ContourExtractResult
    machining_settings: MachiningSettings

class TabSegment(BaseModel):
    start_index: int
    end_index: int
    z_tab: float

class ToolpathPass(BaseModel):
    pass_number: int
    z_depth: float
    path: list[list[float]]
    tabs: list[TabSegment]

class Toolpath(BaseModel):
    operation_id: str
    passes: list[ToolpathPass]

class ToolpathGenResult(BaseModel):
    toolpaths: list[Toolpath]
```

### PostProcessor 関連

```python
class SpindleWarmup(BaseModel):
    initial_rpm: int = 5000
    wait_seconds: int = 2

class MaterialSettings(BaseModel):
    width: float = 600
    depth: float = 400
    thickness: float = 18
    x_offset: float = 0
    y_offset: float = 0

class PostProcessorSettings(BaseModel):
    machine: str = "shopbot"
    output_format: str = "sbp"
    unit: str = "mm"
    safe_z: float = 38.0
    home_position: list[float] = [0.0, 0.0]
    tool_number: int = 3
    spindle_warmup: SpindleWarmup = SpindleWarmup()
    material: MaterialSettings = MaterialSettings()

class SbpGenRequest(BaseModel):
    toolpath_result: ToolpathGenResult
    machining_settings: MachiningSettings
    post_processor: PostProcessorSettings

class SbpGenResult(BaseModel):
    sbp_code: str
    filename: str
```

## ツールパス計算ロジック

### 多段Zステップダウン

材料表面から `depth_per_pass` ずつ掘り下げ、`total_depth` に達するまでパスを繰り返す。

```
材料表面 Z = material_thickness (e.g. 18mm)
Pass 1: Z = thickness - depth_per_pass          (e.g. 12mm)
Pass 2: Z = thickness - 2 * depth_per_pass      (e.g. 6mm)
Pass 3: Z = -penetration_margin                  (e.g. -0.3mm)
```

- 最終パスは常に `Z = -0.3mm`（貫通マージン）
- 各パスで同一の輪郭座標を使用（2D contour 加工）
- パス間は同じ開始点で Z だけ下げる（連続的）
- v1 は Plunge（垂直降下）。降下処理を関数分離し、将来 Ramp-in に置換可能に

### タブ処理

タブは最終パスのみに挿入。

1. 輪郭の全周長を計算
2. `tabs.count` に基づき等間隔にタブ位置を決定
3. タブ位置で Z を `thickness - tab_height` まで持ち上げ
4. タブ幅分だけ水平移動後、元の Z に戻す

### SBP コマンドの使い分け

| 状態 | コマンド | 用途 |
|------|---------|------|
| 中空移動 | `J2` (XY) / `J3` (XYZ) | ポジショニング、退避 |
| 切削移動 | `M3` (XYZ) | 材料切削中 |

## SBP コード生成

### 出力ファイル構造

```sbp
'--- ヘッダー ---
'SHOPBOT ROUTER FILE IN MM
'GENERATED BY PathDesigner
IF %(25)=0 THEN GOTO UNIT_ERROR
SA
CN,90

'--- ツール・スピンドル ---
&Tool = {tool_number}
C9
TR,{spindle_warmup.initial_rpm}
C6
PAUSE {spindle_warmup.wait_seconds}

'--- 材料メタデータ ---
'MATERIAL_WIDTH:{material.width}
'MATERIAL_DEPTH:{material.depth}
'MATERIAL_THICKNESS:{material.thickness}
'MILL_SIZE:{tool.diameter}

'--- 速度設定 ---
MS,{feed_rate.xy},{feed_rate.z}
JS,{jog_speed}

'--- 安全位置 ---
JZ,{safe_z}
J2,{home_position[0]},{home_position[1]}

'--- 切削パス ---
J2,start_x,start_y
M3,start_x,start_y,{material_thickness}
M3,start_x,start_y,{z_pass_1}
M3,x1,y1,{z_pass_1}
... (輪郭一周)
M3,start_x,start_y,{z_pass_2}
... (タブ付き最終パス)

'--- 終了処理 ---
JZ,{safe_z}
J2,{home_position[0]},{home_position[1]}
C7
END

UNIT_ERROR:
CN, 91
END
```

### `sbp_writer.py` クラス設計

```python
class SbpWriter:
    def __init__(self, settings: PostProcessorSettings, machining: MachiningSettings):
        ...

    def generate(self, toolpaths: list[Toolpath]) -> str:
        lines = []
        lines += self._header()
        lines += self._tool_spindle()
        lines += self._material_metadata()
        lines += self._speed_settings()
        lines += self._initial_position()
        for tp in toolpaths:
            lines += self._cutting_passes(tp)
        lines += self._footer()
        return "\n".join(lines)
```

## フロントエンド

### PostProcessorNode

- ハンドル: source `{id}-out` (settings)
- UI: safe_z, home_position, tool_number, material サイズ等のフォーム
- MachiningSettingsNode と同じパターン

### ToolpathGenNode

- ハンドル:
  - target `{id}-contour` (geometry)
  - target `{id}-settings` (settings)
  - target `{id}-postprocessor` (settings)
- UI:
  - 「生成」ボタン → API 2つを順番に呼ぶ
  - 生成結果サマリ（パス数、合計Z深さ）
  - 「SBP ダウンロード」ボタン

### データフロー（Phase 4 完了後）

```
BrepImport → ContourExtract ← MachiningSettings
                   ↓
            ToolpathGen ← PostProcessor
                   ↓
            [SBP ダウンロード]
```

### Sidebar
- `postProcessor` と `toolpathGen` をドラッグ可能ノードとして追加
