# Phase D: Code Node Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** build123dã‚³ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§æ›¸ã„ã¦å®Ÿè¡Œã§ãã‚‹CodeNodeã‚’è¿½åŠ ã—ã€PlacementNodeã«ç›´çµã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

**Architecture:** ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿ã®å¤‰æ›´ã€‚`CodeEditorPanel`ï¼ˆCodeMirror 6ï¼‰ã‚’ãƒ‘ãƒãƒ«ã‚¿ãƒ–ã«æŒã¤`CodeNode`ã‚’ä½œæˆã—ã€æ—¢å­˜ã®`/ai-cad/execute`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å†åˆ©ç”¨ã™ã‚‹ã€‚å‡ºåŠ›ã¯æ—¢å­˜ã®`brepResult` / `geometry`ãƒãƒ³ãƒ‰ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ ã€‚

**Tech Stack:** React + TypeScript, CodeMirror 6 (`@codemirror/lang-python`, `@codemirror/autocomplete`), æ—¢å­˜FastAPIãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

---

## å‰æçŸ¥è­˜

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
- `frontend/src/nodes/` â€” ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`AiCadNode.tsx`, `SnippetDbNode.tsx` ãŒå‚è€ƒï¼‰
- `frontend/src/components/` â€” ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`AiCadPanel.tsx` ãŒå‚è€ƒï¼‰
- `frontend/src/nodeRegistry.ts` â€” ãƒãƒ¼ãƒ‰ç™»éŒ²ã®å”¯ä¸€ã®èµ·ç‚¹
- `frontend/src/api.ts` â€” APIå‘¼ã³å‡ºã—ï¼ˆ`executeAiCadCode`, `saveSnippet` ã‚’ä½¿ã†ï¼‰
- `frontend/src/types.ts` â€” å‹å®šç¾©ï¼ˆ`AiCadResult`, `SnippetSaveRequest`ï¼‰

### é‡è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³
- ãƒãƒ¼ãƒ‰ã¯çµæœã‚’ `brepResult` ã‚­ãƒ¼ã§ `node.data` ã«ä¿å­˜ã™ã‚‹ï¼ˆ`setNodes` ã§æ›´æ–°ï¼‰
- ãƒ‘ãƒãƒ«ã‚¿ãƒ–ã¯ `usePanelTabs()` ã® `openTab` / `updateTab` ã§ç®¡ç†
- `updateTab` ã¯ `useEffect` å†…ã§ state å¤‰åŒ–ã‚’åæ˜ ã™ã‚‹ãŸã‚ã«ä½¿ã†ï¼ˆSnippetDbNodeå‚ç…§ï¼‰
- å‡ºåŠ›ãƒãƒ³ãƒ‰ãƒ«ã¯ `dataType="geometry"` ã§ PlacementNode ã¨æ¥ç¶š

### ãƒ†ã‚¹ãƒˆæ–¹é‡
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æœªå°å…¥ã®ãŸã‚ã€å„ã‚¿ã‚¹ã‚¯å¾Œã« `npm run build` ã§TypeScriptå‹ã‚¨ãƒ©ãƒ¼ãŒãªã„ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

---

## Task 1: CodeMirrorãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

**Files:**
- Modify: `frontend/package.json`

**Step 1: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm install @codemirror/view @codemirror/state @codemirror/lang-python @codemirror/autocomplete @codemirror/theme-one-dark
```

**Step 2: TypeScriptãƒ“ãƒ«ãƒ‰ã§å•é¡ŒãŒãªã„ã‹ç¢ºèª**

```bash
npm run build
```

Expected: ã‚¨ãƒ©ãƒ¼ãªã—ã§ãƒ“ãƒ«ãƒ‰å®Œäº†ï¼ˆã¾ãŸã¯æ—¢å­˜ã‚¨ãƒ©ãƒ¼ã®ã¿ï¼‰

**Step 3: ã‚³ãƒŸãƒƒãƒˆ**

```bash
git add frontend/package.json frontend/package-lock.json
git commit -m "feat(code-node): install CodeMirror 6 packages (#37)"
```

---

## Task 2: build123dè£œå®Œè¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

**Files:**
- Create: `frontend/src/lib/build123dCompletions.ts`

**Step 1: è£œå®Œè¾æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ**

```typescript
// frontend/src/lib/build123dCompletions.ts
import { CompletionContext, type Completion } from "@codemirror/autocomplete";

// build123d ã®ä¸»è¦ã‚·ãƒ³ãƒœãƒ«ä¸€è¦§ï¼ˆllm_client.py ã®APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‹ã‚‰ç¶²ç¾…ï¼‰
const BUILD123D_COMPLETIONS: Completion[] = [
  // â”€â”€ 3D ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ– â”€â”€
  { label: "Box", type: "class", detail: "Box(length, width, height)", info: "ç›´æ–¹ä½“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä¸­å¿ƒé…ç½®ã€‚" },
  { label: "Cylinder", type: "class", detail: "Cylinder(radius, height)", info: "å††æŸ±ã€‚" },
  { label: "Sphere", type: "class", detail: "Sphere(radius)", info: "çƒã€‚" },
  { label: "Cone", type: "class", detail: "Cone(bottom_radius, top_radius, height)", info: "å††éŒã€‚top_radius=0ã§å°–ã‚Šã€‚" },
  { label: "Torus", type: "class", detail: "Torus(major_radius, minor_radius)", info: "ãƒˆãƒ¼ãƒ©ã‚¹ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ï¼‰ã€‚" },
  { label: "Wedge", type: "class", detail: "Wedge(xsize, ysize, zsize, ...)", info: "ã‚¦ã‚§ãƒƒã‚¸å½¢çŠ¶ã€‚" },
  { label: "Hole", type: "class", detail: "Hole(radius, depth)", info: "BuildPartå†…ã§ä½¿ç”¨ã™ã‚‹ç©´ã€‚" },
  { label: "CounterBoreHole", type: "class", detail: "CounterBoreHole(radius, counter_bore_radius, counter_bore_depth, depth)", info: "ã–ãã‚Šç©´ã€‚" },
  { label: "CounterSinkHole", type: "class", detail: "CounterSinkHole(radius, counter_sink_radius, depth)", info: "çš¿ç©´ã€‚" },
  { label: "Compound", type: "class", detail: "Compound", info: "è¤‡æ•°ã‚½ãƒªãƒƒãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠã€‚" },
  { label: "Part", type: "class", detail: "Part", info: "ã‚½ãƒªãƒƒãƒ‰ãƒ‘ãƒ¼ãƒ„å‹ã€‚" },
  { label: "Solid", type: "class", detail: "Solid", info: "ã‚½ãƒªãƒƒãƒ‰åŸºåº•ã‚¯ãƒ©ã‚¹ã€‚" },

  // â”€â”€ 2D ã‚¹ã‚±ãƒƒãƒ â”€â”€
  { label: "Rectangle", type: "class", detail: "Rectangle(width, height)", info: "çŸ©å½¢ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "RectangleRounded", type: "class", detail: "RectangleRounded(width, height, radius)", info: "è§’ä¸¸çŸ©å½¢ã€‚" },
  { label: "Circle", type: "class", detail: "Circle(radius)", info: "å††ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "Ellipse", type: "class", detail: "Ellipse(x_radius, y_radius)", info: "æ¥•å††ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "Polygon", type: "class", detail: "Polygon(*pts)", info: "å¤šè§’å½¢ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "RegularPolygon", type: "class", detail: "RegularPolygon(radius, side_count)", info: "æ­£å¤šè§’å½¢ã€‚" },
  { label: "Text", type: "class", detail: 'Text("string", font_size)', info: "ãƒ†ã‚­ã‚¹ãƒˆè¼ªéƒ­ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "SlotOverall", type: "class", detail: "SlotOverall(width, height)", info: "ã‚¹ãƒ­ãƒƒãƒˆï¼ˆé•·ä¸¸ï¼‰ã‚¹ã‚±ãƒƒãƒã€‚" },
  { label: "Trapezoid", type: "class", detail: "Trapezoid(width, height, left_side_angle)", info: "å°å½¢ã‚¹ã‚±ãƒƒãƒã€‚" },

  // â”€â”€ 1D ãƒ©ã‚¤ãƒ³ â”€â”€
  { label: "Line", type: "class", detail: "Line(start, end)", info: "ç›´ç·šã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€‚" },
  { label: "Polyline", type: "class", detail: "Polyline(*pts)", info: "æŠ˜ã‚Œç·šã€‚" },
  { label: "Spline", type: "class", detail: "Spline(*pts)", info: "ã‚¹ãƒ—ãƒ©ã‚¤ãƒ³æ›²ç·šã€‚" },
  { label: "CenterArc", type: "class", detail: "CenterArc(center, radius, start_angle, arc_size)", info: "ä¸­å¿ƒå††å¼§ã€‚" },
  { label: "RadiusArc", type: "class", detail: "RadiusArc(start_point, end_point, radius)", info: "åŠå¾„æŒ‡å®šå††å¼§ã€‚" },
  { label: "TangentArc", type: "class", detail: "TangentArc(*pts)", info: "æ¥ç·šå††å¼§ã€‚" },

  // â”€â”€ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ â”€â”€
  { label: "BuildPart", type: "class", detail: "with BuildPart() as bp:", info: "ã‚½ãƒªãƒƒãƒ‰æ§‹ç¯‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚çµæœã¯ bp.partã€‚" },
  { label: "BuildSketch", type: "class", detail: "with BuildSketch(plane) as sk:", info: "ã‚¹ã‚±ãƒƒãƒæ§‹ç¯‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚çµæœã¯ sk.sketchã€‚" },
  { label: "BuildLine", type: "class", detail: "with BuildLine() as bl:", info: "ãƒ©ã‚¤ãƒ³æ§‹ç¯‰ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚é–‰ãƒ«ãƒ¼ãƒ—å¿…é ˆã€‚" },

  // â”€â”€ æ“ä½œé–¢æ•° â”€â”€
  { label: "extrude", type: "function", detail: "extrude(amount=d, mode=Mode.ADD)", info: "ã‚¹ã‚±ãƒƒãƒã‚’æŠ¼ã—å‡ºã—ã€‚mode=Mode.SUBTRACTã§åˆ‡ã‚Šå–ã‚Šã€‚" },
  { label: "revolve", type: "function", detail: "revolve(axis=Axis.Z, revolution_arc=360)", info: "ã‚¹ã‚±ãƒƒãƒã‚’å›è»¢ä½“åŒ–ã€‚" },
  { label: "loft", type: "function", detail: "loft()", info: "è¤‡æ•°ã‚¹ã‚±ãƒƒãƒã‚’ãƒ­ãƒ•ãƒˆã€‚" },
  { label: "sweep", type: "function", detail: "sweep(path)", info: "ãƒ‘ã‚¹ã«æ²¿ã£ã¦ã‚¹ã‚¤ãƒ¼ãƒ—ã€‚" },
  { label: "fillet", type: "function", detail: "fillet(edge_list, radius)", info: "ãƒ•ã‚£ãƒ¬ãƒƒãƒˆã€‚BuildPartå†…ã§ã®ã¿æœ‰åŠ¹ã€‚" },
  { label: "chamfer", type: "function", detail: "chamfer(edge_list, length)", info: "é¢å–ã‚Šã€‚BuildPartå†…ã§ã®ã¿æœ‰åŠ¹ã€‚" },
  { label: "offset", type: "function", detail: "offset(amount=-t, openings=False)", info: "ã‚½ãƒªãƒƒãƒ‰ã‚’ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆã‚·ã‚§ãƒ«åŒ–ï¼‰ã€‚" },
  { label: "mirror", type: "function", detail: "mirror(about=Plane.YZ)", info: "å¹³é¢ã§ãƒŸãƒ©ãƒ¼ã‚³ãƒ”ãƒ¼ã€‚" },
  { label: "make_face", type: "function", detail: "make_face()", info: "ãƒ¯ã‚¤ãƒ¤ã‹ã‚‰é¢ã‚’ç”Ÿæˆã€‚" },
  { label: "scale", type: "function", detail: "scale(by=factor)", info: "ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›ã€‚" },

  // â”€â”€ ä½ç½®ãƒ»å¤‰æ› â”€â”€
  { label: "Pos", type: "class", detail: "Pos(x, y, z)", info: "ä½ç½®å¤‰æ›ã€‚Pos(10,0,0) * shape ã§é…ç½®ã€‚" },
  { label: "Rot", type: "class", detail: "Rot(x_deg, y_deg, z_deg)", info: "å›è»¢å¤‰æ›ã€‚" },
  { label: "Location", type: "class", detail: "Location((x,y,z), (ax,ay,az))", info: "ä½ç½®ã¨å‘ãã‚’æŒ‡å®šã€‚" },
  { label: "Align", type: "class", detail: "Align.MIN / Align.CENTER / Align.MAX", info: "é…ç½®åŸºæº–ç‚¹ã€‚" },

  // â”€â”€ ãƒ‘ã‚¿ãƒ¼ãƒ³é…ç½® â”€â”€
  { label: "Locations", type: "class", detail: "Locations([(x1,y1), (x2,y2), ...])", info: "è¤‡æ•°ä½ç½®ã«é…ç½®ã€‚" },
  { label: "GridLocations", type: "class", detail: "GridLocations(x_spacing, y_spacing, x_count, y_count)", info: "æ ¼å­çŠ¶é…ç½®ã€‚" },
  { label: "PolarLocations", type: "class", detail: "PolarLocations(radius, count)", info: "æ¥µåº§æ¨™çŠ¶é…ç½®ã€‚" },
  { label: "HexLocations", type: "class", detail: "HexLocations(apothem, count, ...)", info: "å…­è§’æ ¼å­é…ç½®ã€‚" },

  // â”€â”€ ãƒ—ãƒ¬ãƒ¼ãƒ³ â”€â”€
  { label: "Plane", type: "class", detail: "Plane.XY / Plane.XZ / Plane.YZ", info: "åŸºæº–å¹³é¢ã€‚Plane.XY.offset(z)ã§ã‚ªãƒ•ã‚»ãƒƒãƒˆã€‚" },
  { label: "Axis", type: "class", detail: "Axis.X / Axis.Y / Axis.Z", info: "åŸºæº–è»¸ã€‚sort_by/filter_byã§ä½¿ç”¨ã€‚" },
  { label: "GeomType", type: "class", detail: "GeomType.CIRCLE / GeomType.LINE", info: "ã‚¸ã‚ªãƒ¡ãƒˆãƒªå‹ãƒ•ã‚£ãƒ«ã‚¿ã€‚" },
  { label: "Mode", type: "class", detail: "Mode.ADD / Mode.SUBTRACT / Mode.INTERSECT", info: "ãƒ–ãƒ¼ãƒ«æ¼”ç®—ãƒ¢ãƒ¼ãƒ‰ã€‚" },
  { label: "Select", type: "class", detail: "Select.ALL / Select.LAST", info: "é¸æŠãƒ¢ãƒ¼ãƒ‰ã€‚" },

  // â”€â”€ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â”€â”€
  { label: "export_step", type: "function", detail: "export_step(shape, file_path)", info: "STEPãƒ•ã‚¡ã‚¤ãƒ«ã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‚" },
  { label: "export_stl", type: "function", detail: "export_stl(shape, file_path)", info: "STLãƒ•ã‚¡ã‚¤ãƒ«ã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€‚" },

  // â”€â”€ ã‚ˆãä½¿ã†å¤‰æ•°å â”€â”€
  { label: "result", type: "variable", detail: "result = ...", info: "å¿…ãšã“ã®å¤‰æ•°åã«æœ€çµ‚å½¢çŠ¶ã‚’ä»£å…¥ã™ã‚‹ã“ã¨ã€‚" },
];

// build123dã®ã™ã¹ã¦ã®importå€™è£œï¼ˆ`from build123d import *` ã®ã‚ã¨ã§ã‚‚è£œå®Œï¼‰
const BUILD123D_IMPORT_LINE = "from build123d import *";

export function build123dCompletionSource(context: CompletionContext) {
  const word = context.matchBefore(/\w*/);
  if (!word || (word.from === word.to && !context.explicit)) return null;

  return {
    from: word.from,
    options: BUILD123D_COMPLETIONS,
    validFor: /^\w*$/,
  };
}

export { BUILD123D_IMPORT_LINE };
export default BUILD123D_COMPLETIONS;
```

**Step 2: ãƒ“ãƒ«ãƒ‰ç¢ºèª**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm run build
```

Expected: å‹ã‚¨ãƒ©ãƒ¼ãªã—

**Step 3: ã‚³ãƒŸãƒƒãƒˆ**

```bash
git add frontend/src/lib/build123dCompletions.ts
git commit -m "feat(code-node): add build123d autocomplete dictionary (#37)"
```

---

## Task 3: CodeEditorPanel ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

**Files:**
- Create: `frontend/src/components/CodeEditorPanel.tsx`

**Step 1: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ**

```typescript
// frontend/src/components/CodeEditorPanel.tsx
import { useCallback, useEffect, useRef, useState } from "react";
import { EditorView, basicSetup } from "codemirror";
import { python } from "@codemirror/lang-python";
import { autocompletion } from "@codemirror/autocomplete";
import { build123dCompletionSource } from "../lib/build123dCompletions";
import { executeAiCadCode, saveSnippet } from "../api";
import type { AiCadResult } from "../types";

const DEFAULT_CODE = `from build123d import *

result = Box(100, 100, 10)
`;

interface Props {
  initialCode?: string;
  onResult: (result: AiCadResult) => void;
}

type RunStatus = "idle" | "running" | "success" | "error";

export default function CodeEditorPanel({ initialCode, onResult }: Props) {
  const editorRef = useRef<HTMLDivElement>(null);
  const viewRef = useRef<EditorView | null>(null);

  const [runStatus, setRunStatus] = useState<RunStatus>("idle");
  const [runError, setRunError] = useState("");
  const [lastResult, setLastResult] = useState<AiCadResult | null>(null);

  // Save dialog state
  const [showSaveDialog, setShowSaveDialog] = useState(false);
  const [saveName, setSaveName] = useState("");
  const [saveTags, setSaveTags] = useState("");
  const [saveStatus, setSaveStatus] = useState<"idle" | "saving" | "saved" | "error">("idle");

  // CodeMirrorã®åˆæœŸåŒ–
  useEffect(() => {
    if (!editorRef.current) return;

    const view = new EditorView({
      doc: initialCode ?? DEFAULT_CODE,
      extensions: [
        basicSetup,
        python(),
        autocompletion({ override: [build123dCompletionSource] }),
        EditorView.theme({
          "&": { height: "360px", fontSize: "12px" },
          ".cm-scroller": { overflow: "auto", fontFamily: "monospace" },
        }),
      ],
      parent: editorRef.current,
    });
    viewRef.current = view;

    return () => view.destroy();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // initialCode ãŒå¤‰åŒ–ã—ãŸã‚‰ editor ã®å†…å®¹ã‚’æ›´æ–°
  useEffect(() => {
    const view = viewRef.current;
    if (!view || initialCode === undefined) return;
    const currentDoc = view.state.doc.toString();
    if (currentDoc !== initialCode) {
      view.dispatch({
        changes: { from: 0, to: currentDoc.length, insert: initialCode },
      });
    }
  }, [initialCode]);

  const getCode = () => viewRef.current?.state.doc.toString() ?? "";

  const handleRun = useCallback(async () => {
    const code = getCode();
    if (!code.trim()) return;
    setRunStatus("running");
    setRunError("");
    try {
      const result = await executeAiCadCode(code);
      setLastResult(result);
      setRunStatus("success");
      onResult(result);
    } catch (e) {
      setRunError(e instanceof Error ? e.message : "Execution failed");
      setRunStatus("error");
    }
  }, [onResult]);

  const handleSaveToLibrary = useCallback(async () => {
    if (!saveName.trim()) return;
    setSaveStatus("saving");
    try {
      await saveSnippet({
        name: saveName.trim(),
        tags: saveTags.split(",").map((t) => t.trim()).filter(Boolean),
        code: getCode(),
      });
      setSaveStatus("saved");
      setTimeout(() => {
        setSaveStatus("idle");
        setShowSaveDialog(false);
        setSaveName("");
        setSaveTags("");
      }, 1500);
    } catch {
      setSaveStatus("error");
    }
  }, [saveName, saveTags]);

  return (
    <div style={containerStyle}>
      {/* ã‚¨ãƒ‡ã‚£ã‚¿ */}
      <div ref={editorRef} style={editorWrapStyle} />

      {/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */}
      <div style={toolbarStyle}>
        <button
          onClick={handleRun}
          disabled={runStatus === "running"}
          style={{ ...runBtnStyle, opacity: runStatus === "running" ? 0.5 : 1 }}
        >
          {runStatus === "running" ? "Running..." : "â–¶ Run"}
        </button>
        <button
          onClick={() => setShowSaveDialog((v) => !v)}
          style={saveBtnStyle}
        >
          Save to Library
        </button>
      </div>

      {/* å®Ÿè¡Œçµæœ */}
      {runStatus === "success" && lastResult && (
        <div style={resultStyle}>
          âœ… {lastResult.object_count} object{lastResult.object_count > 1 ? "s" : ""} generated
          {lastResult.objects.map((obj) => (
            <div key={obj.object_id} style={objStyle}>
              {obj.bounding_box.x.toFixed(1)} Ã— {obj.bounding_box.y.toFixed(1)} Ã— {obj.bounding_box.z.toFixed(1)} mm
            </div>
          ))}
        </div>
      )}
      {runStatus === "error" && (
        <div style={errorStyle}>{runError}</div>
      )}

      {/* ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      {showSaveDialog && (
        <div style={dialogStyle}>
          <input
            value={saveName}
            onChange={(e) => setSaveName(e.target.value)}
            placeholder="ã‚¹ãƒ‹ãƒšãƒƒãƒˆå"
            style={inputStyle}
          />
          <input
            value={saveTags}
            onChange={(e) => setSaveTags(e.target.value)}
            placeholder="ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)"
            style={inputStyle}
          />
          <button
            onClick={handleSaveToLibrary}
            disabled={!saveName.trim() || saveStatus === "saving"}
            style={runBtnStyle}
          >
            {saveStatus === "saving" ? "Saving..." : saveStatus === "saved" ? "Saved!" : "Save"}
          </button>
          {saveStatus === "error" && <div style={errorStyle}>ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</div>}
        </div>
      )}
    </div>
  );
}

const containerStyle: React.CSSProperties = {
  display: "flex", flexDirection: "column", gap: 8, padding: 12, height: "100%",
};
const editorWrapStyle: React.CSSProperties = {
  border: "1px solid #ddd", borderRadius: 6, overflow: "hidden", flex: 1,
};
const toolbarStyle: React.CSSProperties = {
  display: "flex", gap: 8,
};
const runBtnStyle: React.CSSProperties = {
  padding: "6px 16px", border: "none", borderRadius: 6,
  background: "#e65100", color: "white", cursor: "pointer", fontSize: 12, fontWeight: 600,
};
const saveBtnStyle: React.CSSProperties = {
  padding: "6px 16px", border: "1px solid #ddd", borderRadius: 6,
  background: "white", color: "#333", cursor: "pointer", fontSize: 12,
};
const resultStyle: React.CSSProperties = {
  fontSize: 12, color: "#2e7d32", background: "#f1f8e9", padding: "6px 10px", borderRadius: 6,
};
const objStyle: React.CSSProperties = {
  color: "#555", marginTop: 2, fontSize: 11,
};
const errorStyle: React.CSSProperties = {
  fontSize: 11, color: "#d32f2f", background: "#fff3f3", padding: "6px 10px", borderRadius: 6,
  whiteSpace: "pre-wrap",
};
const dialogStyle: React.CSSProperties = {
  display: "flex", flexDirection: "column", gap: 6, padding: "8px 0",
  borderTop: "1px solid #eee",
};
const inputStyle: React.CSSProperties = {
  padding: "6px 10px", border: "1px solid #ddd", borderRadius: 6, fontSize: 12,
};
```

**Step 2: ãƒ“ãƒ«ãƒ‰ç¢ºèª**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm run build
```

Expected: å‹ã‚¨ãƒ©ãƒ¼ãªã—ã€‚`codemirror` ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè§£æ±ºã•ã‚Œã‚‹ã“ã¨ã€‚

> **æ³¨æ„:** `basicSetup` ã¯ `codemirror` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ import ã™ã‚‹ï¼ˆ`@codemirror/view` ã§ã¯ãªã„ï¼‰ã€‚
> ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸: `@codemirror/view`, `@codemirror/state`, `@codemirror/lang-python`, `@codemirror/autocomplete`
> `basicSetup` ã‚’ä½¿ã†ã«ã¯ `codemirror` ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚å¿…è¦: `npm install codemirror`

**Step 2b: `codemirror` ã‚³ã‚¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ãªå ´åˆï¼‰**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm install codemirror
npm run build
```

**Step 3: ã‚³ãƒŸãƒƒãƒˆ**

```bash
git add frontend/src/components/CodeEditorPanel.tsx frontend/package.json frontend/package-lock.json
git commit -m "feat(code-node): add CodeEditorPanel with CodeMirror 6 and build123d completions (#37)"
```

---

## Task 4: CodeNode ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

**Files:**
- Create: `frontend/src/nodes/CodeNode.tsx`

**Step 1: ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆ**

```typescript
// frontend/src/nodes/CodeNode.tsx
import type React from "react";
import { useCallback, useEffect, useState } from "react";
import { Position, type NodeProps, useReactFlow } from "@xyflow/react";
import LabeledHandle from "./LabeledHandle";
import NodeShell from "../components/NodeShell";
import CodeEditorPanel from "../components/CodeEditorPanel";
import type { AiCadResult } from "../types";
import { usePanelTabs } from "../contexts/PanelTabsContext";

type RunStatus = "idle" | "running" | "success" | "error";

export default function CodeNode({ id, selected }: NodeProps) {
  const { openTab, updateTab } = usePanelTabs();
  const { setNodes } = useReactFlow();

  const [status, setStatus] = useState<RunStatus>("idle");
  const [result, setResult] = useState<AiCadResult | null>(null);
  const [code, setCode] = useState<string | undefined>(undefined);

  const handleResult = useCallback(
    (r: AiCadResult) => {
      setResult(r);
      setStatus("success");
      setNodes((nodes) =>
        nodes.map((n) =>
          n.id === id ? { ...n, data: { ...n.data, brepResult: r } } : n,
        ),
      );
    },
    [id, setNodes],
  );

  const panelContent = (
    <CodeEditorPanel
      initialCode={code}
      onResult={handleResult}
    />
  );

  const handleOpenEditor = useCallback(() => {
    openTab({
      id: `code-editor-${id}`,
      label: "Code Editor",
      icon: "{}",
      content: panelContent,
    });
  }, [id, openTab, panelContent]);

  // ã‚¿ãƒ–ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€stateå¤‰åŒ–ã‚’åæ˜ ã™ã‚‹
  useEffect(() => {
    updateTab({
      id: `code-editor-${id}`,
      label: "Code Editor",
      icon: "{}",
      content: panelContent,
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [id, code, result, updateTab]);

  return (
    <NodeShell category="cad" selected={selected}>
      <div style={headerStyle}>Code Node</div>

      <div style={summaryStyle}>
        {status === "success" && result ? (
          <span style={{ color: "#2e7d32" }}>
            âœ… {result.object_count} object{result.object_count > 1 ? "s" : ""}
          </span>
        ) : status === "error" ? (
          <span style={{ color: "#d32f2f" }}>âŒ Error</span>
        ) : (
          <span style={{ color: "#999" }}>ã‚³ãƒ¼ãƒ‰æœªå®Ÿè¡Œ</span>
        )}
      </div>

      <button onClick={handleOpenEditor} style={openBtnStyle}>
        Open Editor
      </button>

      <LabeledHandle
        type="source"
        position={Position.Bottom}
        id={`${id}-out`}
        label="out"
        dataType="geometry"
      />
    </NodeShell>
  );
}

const headerStyle: React.CSSProperties = {
  fontWeight: 700, fontSize: 13, marginBottom: 8, color: "#333",
};
const summaryStyle: React.CSSProperties = {
  fontSize: 12, marginBottom: 8, minHeight: 20,
};
const openBtnStyle: React.CSSProperties = {
  width: "100%", padding: "6px 12px", border: "1px solid #ddd", borderRadius: 6,
  background: "white", color: "#333", cursor: "pointer", fontSize: 11,
};
```

**Step 2: ãƒ“ãƒ«ãƒ‰ç¢ºèª**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm run build
```

Expected: å‹ã‚¨ãƒ©ãƒ¼ãªã—

**Step 3: ã‚³ãƒŸãƒƒãƒˆ**

```bash
git add frontend/src/nodes/CodeNode.tsx
git commit -m "feat(code-node): add CodeNode component (#37)"
```

---

## Task 5: nodeRegistry.ts ã¸ã®ç™»éŒ²

**Files:**
- Modify: `frontend/src/nodeRegistry.ts`

**Step 1: CodeNodeã‚’importã—ã¦ç™»éŒ²**

`frontend/src/nodeRegistry.ts` ã‚’ç·¨é›†ã™ã‚‹ã€‚

importã«è¿½åŠ ï¼ˆæ—¢å­˜ã®importã®å¾Œã«è¿½åŠ ï¼‰:
```typescript
import CodeNode from "./nodes/CodeNode";
```

`NODE_REGISTRY` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå†…ã€`snippetDb` ã®è¡Œã®å¾Œã«è¿½åŠ :
```typescript
  codeNode: { component: CodeNode, label: "Code", category: "cad" },
```

**Step 2: ãƒ“ãƒ«ãƒ‰ç¢ºèª**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner/frontend
npm run build
```

Expected: å‹ã‚¨ãƒ©ãƒ¼ãªã—

**Step 3: ã‚³ãƒŸãƒƒãƒˆ**

```bash
git add frontend/src/nodeRegistry.ts
git commit -m "feat(code-node): register CodeNode in nodeRegistry (#37)"
```

---

## Task 6: å‹•ä½œç¢ºèª

**Step 1: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•**

```bash
cd /Users/hajimetokura/OKRA_local/apps/pathdesigner
make dev
```

**Step 2: ç¢ºèªé …ç›®**

ä»¥ä¸‹ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã™ã‚‹:

1. **ãƒãƒ¼ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆ** â€” ã‚µã‚¤ãƒ‰ãƒãƒ¼ã® CAD ã‚«ãƒ†ã‚´ãƒªã«ã€ŒCodeã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
2. **ãƒãƒ¼ãƒ‰è¿½åŠ ** â€” Code ãƒãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¿½åŠ ã§ãã‚‹ã“ã¨
3. **ã‚¨ãƒ‡ã‚£ã‚¿è¡¨ç¤º** â€” "Open Editor" ãƒœã‚¿ãƒ³ã§ãƒ‘ãƒãƒ«ã‚¿ãƒ–ãŒé–‹ãã“ã¨
4. **ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ** â€” Python ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãŒè‰²ä»˜ã‘ã•ã‚Œã‚‹ã“ã¨
5. **ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ** â€” `Box` ãªã©ã¨æ‰“ã¤ã¨è£œå®Œå€™è£œãŒå‡ºã‚‹ã“ã¨
6. **å®Ÿè¡Œ** â€” "â–¶ Run" ãƒœã‚¿ãƒ³ã§å®Ÿè¡Œ â†’ ãƒãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã« "âœ… 1 object" ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
7. **PlacementNode æ¥ç¶š** â€” Code ãƒãƒ¼ãƒ‰ã® out ãƒãƒ³ãƒ‰ãƒ«ã‚’ PlacementNode ã® input ã«æ¥ç¶šã§ãã‚‹ã“ã¨
8. **ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¿å­˜** â€” "Save to Library" ã§ã‚¹ãƒ‹ãƒšãƒƒãƒˆä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‹ãã€ä¿å­˜ã§ãã‚‹ã“ã¨

**Step 3: ã‚³ãƒŸãƒƒãƒˆï¼ˆç¢ºèªå®Œäº†å¾Œï¼‰**

```bash
git add -p  # å¤‰æ›´ãŒã‚ã‚Œã°
git commit -m "feat(code-node): complete Phase D Code Node implementation (#37)"
```

---

## Task 7: PRä½œæˆ

**Step 1: PRã‚’ä½œæˆ**

```bash
gh pr create \
  --title "feat: Phase D Code Node â€” build123dæ‰‹å‹•ã‚¨ãƒ‡ã‚£ã‚¿ (#37)" \
  --body "$(cat <<'EOF'
## Summary
- CodeMirror 6 ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ 
- build123d API ç¶²ç¾…çš„ãªã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆè¾æ›¸
- æ—¢å­˜ /ai-cad/execute ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å†åˆ©ç”¨
- å‡ºåŠ›ã¯ brepResult / geometry ãƒãƒ³ãƒ‰ãƒ«ã§ PlacementNode ã«ç›´çµå¯èƒ½
- ãƒ‘ãƒãƒ«ã‚¿ãƒ–ã«ã€ŒSave to Libraryã€ã§ã‚¹ãƒ‹ãƒšãƒƒãƒˆDBä¿å­˜

## Test plan
- [ ] ãƒãƒ¼ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã«ã€ŒCodeã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] Open Editor ã§ãƒ‘ãƒãƒ«ã‚¿ãƒ–ãŒé–‹ã
- [ ] Python ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒå‹•ä½œã™ã‚‹
- [ ] build123d ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãŒå‹•ä½œã™ã‚‹
- [ ] Run ã§ã‚¸ã‚ªãƒ¡ãƒˆãƒªãŒç”Ÿæˆã•ã‚Œã‚‹
- [ ] PlacementNode ã¨æ¥ç¶šã§ãã‚‹
- [ ] Save to Library ã§ã‚¹ãƒ‹ãƒšãƒƒãƒˆDBã«ä¿å­˜ã§ãã‚‹
- [ ] npm run build ã§ã‚¨ãƒ©ãƒ¼ãªã—

Closes #37

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```
