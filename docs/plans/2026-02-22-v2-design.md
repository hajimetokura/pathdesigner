# PathDesigner V2 設計ドキュメント

日付: 2026-02-22

## 概要

V1（外形切り抜き専用CAM）を拡張し、interior contour・回転配置・ネスティング・ポケット加工・ドリル加工に対応する。アーキテクチャ面ではデータフローをリアクティブに統一し、Damノードによるフロー制御を導入する。

## アプローチ

インクリメンタル拡張。V1のアーキテクチャを活かしつつ5フェーズで段階的に機能追加。

## フェーズ構成

| フェーズ | 内容 |
|---------|------|
| Phase 7 | データフロー統一 + Damノード |
| Phase 8 | Interior contour + 回転配置 + 衝突判定 |
| Phase 9 | 複数オブジェクトSBP生成 |
| Phase 10 | ネスティング（Auto Nesting） |
| Phase 11 | ポケット加工 + ドリル加工 |

---

## Phase 7: データフロー統一 + Damノード

### 現状の問題

- PlacementNodeは`useStore`でリアクティブ
- OperationNode / ToolpathGenNodeは`getEdges + getNode`でボタン押下時に読む
- 方式が混在し、上流変更が下流に伝播しない

### リアクティブ化

- 全ノードが`useStore`で上流ノードの`data`を購読
- 上流の`data`が変わると`useEffect`で自動的にAPIを叩いて再計算
- 計算中はノードにスピナー表示、エラー時は赤枠表示

### Damノード

- 新しいノードタイプ`DamNode`
- 入力ハンドル1つ、出力ハンドル1つ（passthrough型）
- デフォルトは「閉じた」状態 — 上流データの変更を保持するが下流に流さない
- 「Release」ボタンを押すと保持データを下流に伝播
- 上流データが溜まっていることを示すバッジ表示（黄色ドット）
- ノードパレット（Sidebar）から任意のエッジ間にドラッグ&ドロップで挿入可能
- ハンドルの型（brep / stock / placement / operations / settings）を上流エッジから自動推論
- 型ごとにハンドルの色はLabeledHandleの既存色を踏襲

---

## Phase 8: Interior Contour + 回転配置 + 衝突判定

### Interior Contour

- `contour_extract.py`: 既にinterior輪郭を検出済み。フィルタ条件を追加 — Shapelyで面積算出し、`π * (tool_diameter/2)²`より小さい穴は除外
- `toolpath_gen.py`: `if contour.type != "exterior": continue`を削除。interior contourはオフセット方向を内側（`buffer(-offset)`）に変更
- 加工順序: 各オブジェクトでinterior → exteriorの順
- interiorにもタブ設定を適用可能（ユーザーが選択）
- 刃物径より小さい穴は無視（フィルタリング）

### 回転配置

- `PlacementItem`スキーマに`rotation: int`を追加（0/45/90/135/180/225/270/315）
- PlacementPanel UI: 各パーツに回転ボタン（45度ずつ）を追加。タップするたびに+45°
- Canvas描画: `ctx.rotate(rotation * Math.PI / 180)`でアウトライン描画を回転
- バックエンド: `toolpath_gen.py`で座標変換時に回転行列を適用。`shapely.affinity.rotate(polygon, angle, origin='centroid')`を使用

### 輪郭ベース衝突判定

- バックエンド: `/api/validate-placement`を拡張。各オブジェクトのoutlineをShapely Polygonに変換し、回転適用後、全ペアで`polygon_a.intersects(polygon_b)`をチェック
- ツール径分のマージンも考慮: `polygon.buffer(tool_diameter / 2)`で膨らませてから判定
- フロントエンド: 衝突しているパーツを赤枠でハイライト、衝突メッセージを表示
- 自動配置・手動ドラッグどちらでもリアルタイムに判定（配置変更のたびにAPIコール）

---

## Phase 9: 複数オブジェクトSBP生成

### 加工順序

- オブジェクト間: 配置位置で左下→右上にソート（`y_offset`昇順 → `x_offset`昇順）
- オブジェクト内: interior → exterior の順

### SBPコード構造

```
[ヘッダ] 単位チェック, SA, CN,90
[オブジェクト1]
  ├─ ツール/速度設定（このオブジェクトのsettingsを使用）
  ├─ interior contour パス（全Zパス）
  └─ exterior contour パス（全Zパス、タブ付き）
[オブジェクト間] Safe Zに退避 → 次のオブジェクト開始位置へJog移動
[オブジェクト2]
  ├─ ツール設定が変わる場合のみ再設定
  ├─ interior → exterior
  └─ ...
[フッタ] スピンドルOFF, END
```

### ツール変更の最適化

- 連続するオブジェクト間で設定が同一なら、ツール/速度設定コマンドをスキップ
- ツール径が変わる場合はツールチェンジコマンド（`C9` + `&Tool=N`）を挿入

### API変更

- `/api/generate-sbp`のリクエストスキーマを拡張: `operations[]`の各要素がそれぞれの`settings`を持つ構造はそのまま活かし、オブジェクト順序情報（配置座標）を追加

---

## Phase 10: ネスティング（Auto Nesting）

### 手動配置の強化

- 回転ボタン追加（Phase 8で実装）
- 衝突判定のリアルタイムフィードバック（Phase 8で実装）
- ドラッグ中にスナップガイド表示（材料端からの距離、他パーツとのアラインメント）

### Auto Nestingアルゴリズム

- PlacementPanelに「Auto Nesting」ボタンを追加
- バックエンドに`/api/auto-nesting`エンドポイントを新設
- アルゴリズム: Bottom-Left Fill（BLF）
  1. パーツを面積の大きい順にソート
  2. 各パーツに対して0°/45°/90°/135°/180°/225°/270°/315°の8方向を試す
  3. 材料の左下から走査し、衝突しない最初の位置に配置
  4. 衝突判定はShapelyの`polygon.buffer(tool_diameter/2)`で膨らませた輪郭同士の`intersects()`
- パーツ間マージン: ツール径 + 任意のクリアランス（デフォルト5mm、UIで変更可能）

### 自動配置の結果

- 配置結果をPlacementPanelに反映（Canvas + 数値入力が更新される）
- 自動配置後もユーザーが手動で微調整可能
- 材料に収まらない場合は警告表示（「パーツXが範囲外です」）

---

## Phase 11: ポケット加工 + ドリル加工

### 操作タイプの自動検出（`operation_detector.py`拡張）

判定ロジック:
1. **drill**: 貫通 + 円形 + 直径がドリルビット径以下（例: 12mm以下）
2. **contour**: 貫通 + 上記以外（exterior / interior）
3. **pocket**: 非貫通のくぼみ・溝・座繰り

build123dの面解析で、各フィーチャーの貫通/非貫通・形状・寸法を取得。検出結果はOperationNodeに表示され、ユーザーが確認できる。

### ポケット加工のツールパス

- UIでcontour-parallel（オフセット渦巻き）/ raster（ジグザグ）を選択可能
- **Contour-parallel**: Shapelyの`buffer(-step_over)`を繰り返し適用。ステップオーバーはツール径の40-80%（UIで設定）
- **Raster**: ポケット領域のBB内をジグザグ走査、Shapelyで領域内のみクリップ
- Z段送りはcontourと同じロジックを共用（`_compute_passes`）
- 最終パスの深さは指定深さぴったり（貫通しない）

### ドリル加工のツールパス

- ペックドリルサイクル: `depth_per_peck`（デフォルト: 材料厚の1/3）ずつ掘り、毎回Safe Zまで退避して切粉を排出
- SBP出力: `MZ`コマンド（Z軸のみ移動）でペック動作を記述

### SBPでの加工順序（オブジェクト内）

1. drill（穴あけ）
2. pocket（ポケット）
3. interior contour（内部切り抜き）
4. exterior contour（外形切り抜き）

軽い加工から重い加工へ、内側から外側へ。

---

## 横断的な設計判断

| 項目 | 決定 |
|------|------|
| データフロー | リアクティブ（useStore）、重い箇所はDamノードで制御 |
| 回転 | 45度単位（8方向） |
| 衝突判定 | 輪郭ベース + ツール径マージン |
| 加工順序（オブジェクト内） | drill → pocket → interior contour → exterior contour |
| 加工順序（オブジェクト間） | 配置位置で左下→右上ソート |
| 操作検出 | 形状ベース自動判定（貫通/非貫通 × 形状 × 径） |
| Interior contour | 刃物径より小さい穴は無視 |
| ポケットツールパス | contour-parallel / raster 選択可能 |
| ドリル | ペックドリルサイクル |
| ネスティング | BLFアルゴリズム + 手動微調整 |
