# Phase B: Code Library Node â€” è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**Date:** 2026-02-25
**Issue:** #35
**Status:** è¨­è¨ˆæ‰¿èªæ¸ˆã¿

## æ¦‚è¦

ãƒãƒ£ãƒƒãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ³ã§æ”¹å–„ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’åå‰ãƒ»ã‚¿ã‚°ä»˜ãã§ä¿å­˜ã—ã€React Flow ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã® **Code Library Node** ã‹ã‚‰å–ã‚Šå‡ºã—ã¦å†åˆ©ç”¨ã§ãã‚‹ä»•çµ„ã¿ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

```
AI Node â”€â”€â†’ Code Library Node â”€â”€â†’ Code Node (Phase D) â”€â”€â†’ Operation
                    â†•
              snippets DB
```

- **Input ã«æ¥ç¶šï¼ˆä¿å­˜ãƒ¢ãƒ¼ãƒ‰ï¼‰**: AI Node ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ JSON ã‚’å—ã‘å–ã‚Šã€åå‰ãƒ»ã‚¿ã‚°ä»˜ãã§ä¿å­˜
- **Output ã«æ¥ç¶šï¼ˆå–ã‚Šå‡ºã—ãƒ¢ãƒ¼ãƒ‰ï¼‰**: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’é¸æŠã—ã€ã‚³ãƒ¼ãƒ‰å†å®Ÿè¡Œå¾Œã« AI Node ã¨åŒã˜å‡ºåŠ›å‹ã‚’ä¸‹æµã«æµã™
- Input ã¨ Output ã¯ç‹¬ç«‹ã—ã¦å‹•ä½œï¼ˆç‰‡æ–¹ã ã‘æ¥ç¶šã‚‚å¯ï¼‰

### ã‚¨ãƒƒã‚¸ã§æµã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿å‹

**Inputï¼ˆAI Node â†’ Code Library Nodeï¼‰:**
```json
{
  "code": "from build123d import ...",
  "generation_id": "uuid",
  "file_id": "uuid",
  "objects": [...],
  "object_count": 2
}
```

**Outputï¼ˆCode Library Node â†’ ä¸‹æµãƒãƒ¼ãƒ‰ï¼‰:**
AI Node ã®å‡ºåŠ›ã¨åŒã˜å‹ï¼ˆ`AiCadResult` äº’æ›ï¼‰:
```json
{
  "code": "...",
  "generation_id": "uuid",
  "file_id": "uuid",
  "objects": [...],
  "object_count": 2,
  "prompt_used": "",
  "model_used": "snippet"
}
```

Output æ™‚ã¯ `POST /snippets/{id}/execute` ã§ã‚³ãƒ¼ãƒ‰ã‚’å†å®Ÿè¡Œã—ã¦æ–°ã—ã„ `file_id` ã‚’ç”Ÿæˆã™ã‚‹ã€‚

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

### DB ã‚¹ã‚­ãƒ¼ãƒ

`generations` ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã¯ç‹¬ç«‹ã—ãŸ `snippets` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ–°è¨­ã™ã‚‹ã€‚

```sql
CREATE TABLE snippets (
  id                   TEXT PRIMARY KEY,
  name                 TEXT NOT NULL,
  tags                 TEXT,        -- JSONé…åˆ— e.g. ["box", "simple"]
  code                 TEXT NOT NULL,
  thumbnail_png        TEXT,        -- base64 PNG 128Ã—128ï¼ˆä»»æ„ï¼‰
  source_generation_id TEXT,        -- generations.id ã¸ã®å‚ç…§ï¼ˆä»»æ„ï¼‰
  created_at           TEXT NOT NULL,
  updated_at           TEXT NOT NULL
);
```

### API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ãƒ¡ã‚½ãƒƒãƒ‰ | ãƒ‘ã‚¹ | æ¦‚è¦ |
|---------|------|------|
| `POST` | `/snippets` | ã‚¹ãƒ‹ãƒšãƒƒãƒˆä¿å­˜ |
| `GET` | `/snippets?q=&tags=` | ä¸€è¦§å–å¾—ï¼ˆåå‰/ã‚¿ã‚°æ¤œç´¢ã€æœ€æ–°é †ï¼‰ |
| `DELETE` | `/snippets/{id}` | å‰Šé™¤ |
| `POST` | `/snippets/{id}/execute` | ã‚³ãƒ¼ãƒ‰å†å®Ÿè¡Œ â†’ AI Node äº’æ›ã®å‡ºåŠ›å‹ã‚’è¿”ã™ |

`/snippets/{id}/execute` ã¯å†…éƒ¨ã§æ—¢å­˜ã® `execute_build123d_code()` ã‚’å‘¼ã³å‡ºã™ã€‚

### Pydantic ã‚¹ã‚­ãƒ¼ãƒ

```python
class SnippetSaveRequest(BaseModel):
    name: str
    tags: list[str] = []
    code: str
    thumbnail_png: str | None = None   # base64
    source_generation_id: str | None = None

class SnippetInfo(BaseModel):
    id: str
    name: str
    tags: list[str]
    code: str
    thumbnail_png: str | None
    source_generation_id: str | None
    created_at: str

class SnippetListResponse(BaseModel):
    snippets: list[SnippetInfo]
    total: int
```

## ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

### æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

- `frontend/src/nodes/SnippetDbNode.tsx` â€” Code Library Node æœ¬ä½“

### å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

- `frontend/src/types.ts` â€” `SnippetInfo`, `SnippetDbNodeData` å‹è¿½åŠ 
- `frontend/src/api.ts` â€” ã‚¹ãƒ‹ãƒšãƒƒãƒˆ CRUD é–¢æ•°è¿½åŠ 
- `frontend/src/App.tsx` â€” ãƒãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ç™»éŒ²

### Code Library Node UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“š Code Library                    â”‚
â”‚                                     â”‚
â”‚  â”€â”€ ä¿å­˜ã‚¨ãƒªã‚¢ï¼ˆinputæ¥ç¶šæ™‚ã«æœ‰åŠ¹ï¼‰â”€â”€ â”‚
â”‚  åå‰: [___________________]        â”‚
â”‚  ã‚¿ã‚°: [box, simple       ]        â”‚
â”‚  [ğŸ–¼ï¸ ã‚µãƒ ãƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼]              â”‚
â”‚  [         ä¿å­˜         ]           â”‚
â”‚                                     â”‚
â”‚  â”€â”€ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚  ğŸ” [æ¤œç´¢___________]               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ğŸ–¼ï¸   â”‚ â”‚ğŸ–¼ï¸   â”‚ â”‚ğŸ–¼ï¸   â”‚        â”‚
â”‚  â”‚Box  â”‚ â”‚Hook â”‚ â”‚Brkt â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  [é¸æŠã—ã¦å®Ÿè¡Œ]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â—‹ input              output â—‹
```

### ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ

ä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼š

1. Input ãƒ‡ãƒ¼ã‚¿ã® `file_id` ã‹ã‚‰ãƒ¡ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
2. éè¡¨ç¤ºã® `<canvas 128Ã—128>` ã‚’ç”Ÿæˆ
3. Three.js ã§ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚«ãƒ¡ãƒ©ãƒ»ãƒ©ã‚¤ãƒˆãƒ»ã‚¸ã‚ªãƒ¡ãƒˆãƒªï¼‰
4. `canvas.toDataURL('image/png')` â†’ base64 æ–‡å­—åˆ—
5. `POST /snippets` ã® `thumbnail_png` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å«ã‚ã¦é€ä¿¡

### ä¿å­˜ãƒ•ãƒ­ãƒ¼

1. AI Node â†’ Code Library Node ã® Input ã«ã‚¨ãƒƒã‚¸ã‚’ç¹‹ã
2. ä¿å­˜ã‚¨ãƒªã‚¢ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ï¼ˆåå‰ãƒ»ã‚¿ã‚°å…¥åŠ›å¯ï¼‰
3. åå‰ãƒ»ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã€Œä¿å­˜ã€æŠ¼ä¸‹
4. ã‚µãƒ ãƒç”Ÿæˆ â†’ `POST /snippets`
5. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚°ãƒªãƒƒãƒ‰ã«å³åæ˜ 

### å–ã‚Šå‡ºã—ãƒ•ãƒ­ãƒ¼

1. ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
2. ã€Œé¸æŠã—ã¦å®Ÿè¡Œã€æŠ¼ä¸‹ â†’ `POST /snippets/{id}/execute`
3. çµæœï¼ˆAI Node ã¨åŒã˜å‹ï¼‰ã‚’ Output ãƒãƒ³ãƒ‰ãƒ«ã‹ã‚‰ä¸‹æµã«æµã™
4. Output ã«æ¥ç¶šã•ã‚ŒãŸ Code Node ã¾ãŸã¯ Operation Node ãŒå—ã‘å–ã‚‹

## ãƒ†ã‚¹ãƒˆæ–¹é‡

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆ`backend/tests/test_snippets.py` æ–°è¦ï¼‰

- ã‚¹ãƒ‹ãƒšãƒƒãƒˆä¿å­˜ãƒ»å–å¾—ãƒ»å‰Šé™¤ã® CRUD ãƒ†ã‚¹ãƒˆ
- ã‚¿ã‚°ãƒ»åå‰ã§ã®æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ†ã‚¹ãƒˆ
- `/snippets/{id}/execute` ã§ã‚³ãƒ¼ãƒ‰å†å®Ÿè¡Œ â†’ AI Node äº’æ›ã®å‡ºåŠ›å‹ç¢ºèª
- ä¸æ­£ãªã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

- æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ¼ãƒ‰æ¥ç¶šãƒ»ä¿å­˜ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé¸æŠãƒ»å®Ÿè¡Œãƒ»ä¸‹æµæ¥ç¶šï¼‰

## ä¾å­˜é–¢ä¿‚

- Phase A (#34) âœ… å®Œäº†æ¸ˆã¿ï¼ˆãƒãƒ£ãƒƒãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ³ã§ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰
- Phase C (#36)ã€Phase D (#37) ã¯ã“ã® Phase B ã®å®Œäº†å¾Œã«ç€æ‰‹
